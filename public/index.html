<!DOCTYPE html>
<html lang="en">

<!--
  Copyright (c) 2013, 2014 IBM Corporation.

   All rights reserved. This program and the accompanying materials
   are made available under the terms of the Eclipse Public License v1.0
   and Eclipse Distribution License v. 1.0 which accompanies this distribution.

   The Eclipse Public License is available at http://www.eclipse.org/legal/epl-v10.html
   and the Eclipse Distribution License is available at
   http://www.eclipse.org/org/documents/edl-v10.php.

   Contributors:

      Steve Speicher - Based on work at http://eclipse.org/lyo
      Jim Amsden - Based on OSLC4JS development
      Neil Davis - Based on OSLC4JS development
-->

<head>
    <meta charset="UTF-8">
    <title>Linked Data Platform Reference Implementation</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>

<body>

    <h1><a href="http://www.w3.org/2012/ldp/" title="LDP">Linked Data Platform</a> Reference Implementation</h1>
    <p>Enter a resource URI and click <strong>Explore</strong> to visualize its RDF graph, or use the CRUD tabs below.</p>

    <div id="explore-bar">
        <input type="url" id="exploreURI" class="urlInput" value="" placeholder="Enter resource URI...">
        <button id="exploreBtn">Explore</button>
    </div>

    <div id="visualization">
        <svg id="graph"></svg>
    </div>

    <div id="crud-panel">
        <div class="tabs">
            <a href="#" id="getTab" class="tab-link active">GET</a> |
            <a href="#" id="putTab" class="tab-link">PUT</a> |
            <a href="#" id="postTab" class="tab-link">POST</a> |
            <a href="#" id="deleteTab" class="tab-link">DELETE</a>
        </div>

        <div id="get" class="tabContent">
            <form id="getForm" action="">
                <input type="url" id="getURI" class="urlInput" value="" required>
                <select id="getMediaType">
                    <option>text/turtle</option>
                    <option>application/json</option>
                </select>
                <input type="submit" value="GET">
            </form>
            <div id="resources" class="fixed">Enter a URI and click GET to load a resource.</div>
        </div>

        <div id="put" class="tabContent" style="display: none;">
            <form id="putForm" action="">
                <input type="url" id="putURI" class="urlInput" value="" required>
                <select id="putMediaType">
                    <option>text/turtle</option>
                    <option>application/json</option>
                </select>
                <input type="submit" value="PUT">
                <div id="putResult" style="display: none;" class="message"></div>
                <textarea id="putContent" class="textArea fixed" required></textarea>
            </form>
        </div>

        <div id="post" class="tabContent" style="display: none;">
            <form id="postForm" action="">
                <input type="url" id="postURI" class="urlInput" value="" required>
                <select id="postMediaType">
                    <option>text/turtle</option>
                    <option>application/json</option>
                    <option>application/rdf+xml</option>
                </select>
                <input type="submit" value="POST">
                <div id="postResult" style="display: none;" class="message"></div>
                <textarea id="postContent" class="textArea fixed" required>
@prefix dcterms: &lt;http://purl.org/dc/terms/&gt;.
@prefix rdf:     &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt;.
@prefix bt:      &lt;http://example.org/vocab/bugtracker#&gt;.

&lt;&gt; a bt:Bug;
      dcterms:title "Product C crashes when shutting down.";
      bt:isInState "New" .
                </textarea>
            </form>
        </div>

        <div id="delete" class="tabContent" style="display: none;">
            <form id="deleteForm" action="">
                <input type="url" id="deleteURI" class="urlInput" value="" required>
                <input type="submit" value="DELETE">
                <div id="deleteResult" style="display: none;" class="message"></div>
            </form>
        </div>
    </div>

    <script>
    (function () {
        'use strict';

        // ── State ──────────────────────────────────────────────
        const nodes = [];       // { id, label, depth, x, y, fx, fy }
        const links = [];       // { source, target, predicateLabel }
        const expanded = new Set();
        const nodeIndex = {};   // id → node object

        // ── SVG setup ──────────────────────────────────────────
        const width = Math.max(window.innerWidth - 40, 600);
        const height = 500;
        const svg = d3.select('#graph')
            .attr('width', width)
            .attr('height', height);

        // Arrow marker for directed edges
        svg.append('defs').append('marker')
            .attr('id', 'arrowhead')
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 20)
            .attr('refY', 0)
            .attr('markerWidth', 6)
            .attr('markerHeight', 6)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M0,-5L10,0L0,5')
            .attr('fill', '#999');

        const linkGroup = svg.append('g').attr('class', 'links');
        const linkLabelGroup = svg.append('g').attr('class', 'link-labels');
        const nodeGroup = svg.append('g').attr('class', 'nodes');

        const color = d3.scaleOrdinal(d3.schemeTableau10);

        const simulation = d3.forceSimulation()
            .force('link', d3.forceLink().id(d => d.id).distance(120))
            .force('charge', d3.forceManyBody().strength(-300))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide(30))
            .on('tick', ticked);

        simulation.stop();

        // ── Visualization fetch & expand ───────────────────────
        async function expandNode(uri, depth) {
            if (expanded.has(uri)) return;
            expanded.add(uri);

            let data;
            try {
                const resp = await fetch('/v?uri=' + encodeURIComponent(uri));
                if (!resp.ok) {
                    console.warn('Failed to fetch', uri, resp.status);
                    return;
                }
                data = await resp.json();
            } catch (err) {
                console.warn('Fetch error for', uri, err);
                return;
            }

            // Add or update the root node
            if (!nodeIndex[data.uri]) {
                const n = { id: data.uri, label: data.label, depth: depth };
                nodes.push(n);
                nodeIndex[data.uri] = n;
            } else {
                nodeIndex[data.uri].label = data.label;
            }

            // Add child nodes and links
            for (const ref of data.references) {
                if (!nodeIndex[ref.object]) {
                    // Use last path segment as temporary label until expanded
                    const tempLabel = ref.object.split('/').filter(Boolean).pop() || ref.object;
                    const child = { id: ref.object, label: tempLabel, depth: depth + 1 };
                    nodes.push(child);
                    nodeIndex[ref.object] = child;
                }
                links.push({
                    source: data.uri,
                    target: ref.object,
                    predicateLabel: ref.predicateLabel,
                });
            }

            updateGraph();
        }

        function updateGraph() {
            // Links
            const link = linkGroup.selectAll('line')
                .data(links, d => d.source.id + '-' + d.target.id + '-' + d.predicateLabel);
            link.exit().remove();
            link.enter().append('line')
                .attr('class', 'link')
                .attr('marker-end', 'url(#arrowhead)');

            // Link labels
            const linkLabel = linkLabelGroup.selectAll('text')
                .data(links, d => d.source.id + '-' + d.target.id + '-' + d.predicateLabel);
            linkLabel.exit().remove();
            linkLabel.enter().append('text')
                .attr('class', 'link-label')
                .text(d => d.predicateLabel);

            // Nodes
            const node = nodeGroup.selectAll('g.node')
                .data(nodes, d => d.id);
            node.exit().remove();

            const enter = node.enter().append('g')
                .attr('class', 'node')
                .style('cursor', 'pointer')
                .on('click', (event, d) => {
                    event.stopPropagation();
                    expandNode(d.id, d.depth);
                })
                .call(d3.drag()
                    .on('start', dragStarted)
                    .on('drag', dragged)
                    .on('end', dragEnded));

            enter.append('circle')
                .attr('r', 10)
                .attr('fill', d => color(d.depth));

            enter.append('text')
                .attr('x', 14)
                .attr('dy', '0.35em')
                .text(d => d.label);

            // Restart simulation
            simulation.nodes(nodes);
            simulation.force('link').links(links);
            simulation.alpha(0.8).restart();
        }

        function ticked() {
            linkGroup.selectAll('line')
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

            linkLabelGroup.selectAll('text')
                .attr('x', d => (d.source.x + d.target.x) / 2)
                .attr('y', d => (d.source.y + d.target.y) / 2);

            nodeGroup.selectAll('g.node')
                .attr('transform', d => 'translate(' + d.x + ',' + d.y + ')');
        }

        function dragStarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragEnded(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // ── Explore button ─────────────────────────────────────
        document.getElementById('exploreBtn').addEventListener('click', () => {
            const uri = document.getElementById('exploreURI').value.trim();
            if (!uri) return;
            // Reset graph state
            nodes.length = 0;
            links.length = 0;
            expanded.clear();
            for (const k of Object.keys(nodeIndex)) delete nodeIndex[k];
            linkGroup.selectAll('*').remove();
            linkLabelGroup.selectAll('*').remove();
            nodeGroup.selectAll('*').remove();
            expandNode(uri, 0);
        });

        // ── Tab switching ──────────────────────────────────────
        function showTab(tabId, contentId) {
            document.querySelectorAll('.tab-link').forEach(a => a.classList.remove('active'));
            document.querySelectorAll('.tabContent').forEach(div => div.style.display = 'none');
            document.getElementById(tabId).classList.add('active');
            document.getElementById(contentId).style.display = '';
        }

        document.getElementById('getTab').addEventListener('click', e => { e.preventDefault(); showTab('getTab', 'get'); });
        document.getElementById('putTab').addEventListener('click', e => { e.preventDefault(); showTab('putTab', 'put'); });
        document.getElementById('postTab').addEventListener('click', e => { e.preventDefault(); showTab('postTab', 'post'); });
        document.getElementById('deleteTab').addEventListener('click', e => { e.preventDefault(); showTab('deleteTab', 'delete'); });

        // ── Default URIs ───────────────────────────────────────
        const baseURI = new URL('/univ/', window.location.origin).href;
        document.getElementById('exploreURI').value = baseURI;
        document.getElementById('getURI').value = baseURI;
        document.getElementById('postURI').value = baseURI;

        // ── CRUD operations ────────────────────────────────────
        document.getElementById('getForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const uri = document.getElementById('getURI').value;
            const accept = document.getElementById('getMediaType').value;
            try {
                const resp = await fetch(uri, { headers: { Accept: accept } });
                const text = await resp.text();
                document.getElementById('resources').textContent = text;

                // Prefill PUT and DELETE
                document.getElementById('putURI').value = uri;
                document.getElementById('putContent').value = text;
                document.getElementById('deleteURI').value = uri;
            } catch (err) {
                document.getElementById('resources').textContent = 'Error: ' + err.message;
            }
        });

        document.getElementById('putForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const uri = document.getElementById('putURI').value;
            const contentType = document.getElementById('putMediaType').value;
            const body = document.getElementById('putContent').value;
            const resultEl = document.getElementById('putResult');
            try {
                const resp = await fetch(uri, {
                    method: 'PUT',
                    headers: { 'Content-Type': contentType },
                    body: body,
                });
                if (resp.ok) {
                    resultEl.textContent = 'Updated resource ' + uri;
                    resultEl.className = 'message';
                } else {
                    resultEl.innerHTML = '<span class="error">Could not update resource (' + resp.status + ')</span>';
                }
                resultEl.style.display = '';
            } catch (err) {
                resultEl.innerHTML = '<span class="error">Error: ' + err.message + '</span>';
                resultEl.style.display = '';
            }
        });

        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const uri = document.getElementById('postURI').value;
            const contentType = document.getElementById('postMediaType').value;
            const body = document.getElementById('postContent').value;
            const resultEl = document.getElementById('postResult');
            try {
                const resp = await fetch(uri, {
                    method: 'POST',
                    headers: { 'Content-Type': contentType },
                    body: body,
                });
                if (resp.ok) {
                    const location = resp.headers.get('Location');
                    resultEl.textContent = 'Created resource ' + (location || uri);
                    resultEl.className = 'message';
                } else {
                    resultEl.innerHTML = '<span class="error">Could not create resource (' + resp.status + ')</span>';
                }
                resultEl.style.display = '';
            } catch (err) {
                resultEl.innerHTML = '<span class="error">Error: ' + err.message + '</span>';
                resultEl.style.display = '';
            }
        });

        document.getElementById('deleteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const uri = document.getElementById('deleteURI').value;
            const resultEl = document.getElementById('deleteResult');
            try {
                const resp = await fetch(uri, { method: 'DELETE' });
                if (resp.ok) {
                    resultEl.textContent = 'Deleted resource ' + uri;
                    resultEl.className = 'message';
                } else {
                    resultEl.innerHTML = '<span class="error">Could not delete resource (' + resp.status + ')</span>';
                }
                resultEl.style.display = '';
            } catch (err) {
                resultEl.innerHTML = '<span class="error">Error: ' + err.message + '</span>';
                resultEl.style.display = '';
            }
        });

    })();
    </script>

</body>

</html>
